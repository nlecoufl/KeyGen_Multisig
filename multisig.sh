# Raw transaction API example work-through
# Send coins to a 2-of-3 multisig, then spend them.
#
# For this example, I'm using these three keypairs (public/private)
# 02e8c3591920ea995332889ff3b66df83b5a26fb9cd6ab10d78e54909e2892ff34 / p2wpkh:cPVXpU3axwSWptbppzkVKL1Ep8jLqrcxSsiNnqyDfkwu9z9xUArK (the UTXO is on the public address of this keypair)
# 02c522ba9d5063c526c46c5750f22c96d0593c40537e19dc3ffd41a98914f39f07 / p2wpkh:cStuGJkCJkjUX4naKB5E8MWJNFVgCLLXDFuns7rbCN16KrY9iNdE
# 03f587bc04d50edd8a4c1e99f9cdb503e0e55e354b97d7ed9f79017f0c42589d94 / p2wpkh:cNMT9vs77NyDt1LDqqSeYnpZ9kbc1TQFfDhsztcqYFfwqNMka1B8

# First: combine the three keys into a multisig address:
bitcoin-cli -testnet createmultisig 2 '["02e8c3591920ea995332889ff3b66df83b5a26fb9cd6ab10d78e54909e2892ff34","02c522ba9d5063c526c46c5750f22c96d0593c40537e19dc3ffd41a98914f39f07","03f587bc04d50edd8a4c1e99f9cdb503e0e55e354b97d7ed9f79017f0c42589d94"]'

{
  "address": "2N6TdNCysspNgxoEt8Npsqc2KDuJ4W1zvTL",
  "redeemScript": "522102e8c3591920ea995332889ff3b66df83b5a26fb9cd6ab10d78e54909e2892ff342102c522ba9d5063c526c46c5750f22c96d0593c40537e19dc3ffd41a98914f39f072103f587bc04d50edd8a4c1e99f9cdb503e0e55e354b97d7ed9f79017f0c42589d9453ae"
}


# Next, we create a transaction to send funds into that multisig
# Done with electrum, I had trouble when I had to send the transaction with bitcoin-cli. I guess it is because the UTXO I used is not in the bitcoin-cli wallet.

# Now, create a transaction that will spend that multisig transaction. First, I need the txid of the transaction I just created, looking at the details of the transaction in electrum I got : 
# "txid" : "05a62d7727d237f249f86ae3eb6a255a3c5cd40a406065e2c64292d311e75d30"
# Then in a block explorer I got : 
# "scriptPubKey":"a91490f224460e4fd1015baf429c229d6bb5e464413587"
# "redeemScript":"522102e8c3591920ea995332889ff3b66df83b5a26fb9cd6ab10d78e54909e2892ff342102c522ba9d5063c526c46c5750f22c96d0593c40537e19dc3ffd41a98914f39f072103f587bc04d50edd8a4c1e99f9cdb503e0e55e354b97d7ed9f79017f0c42589d9453ae"

# Create the spend-from-multisig transaction. Since the fund-the-multisig transaction hasn't been sent yet, I need to give txid, scriptPubKey and redeemScript:
bitcoin-cli -testnet createrawtransaction '[{"txid":"05a62d7727d237f249f86ae3eb6a255a3c5cd40a406065e2c64292d311e75d30","vout":0,"scriptPubKey":"a91490f224460e4fd1015baf429c229d6bb5e464413587","redeemScript":"522102e8c3591920ea995332889ff3b66df83b5a26fb9cd6ab10d78e54909e2892ff342102c522ba9d5063c526c46c5750f22c96d0593c40537e19dc3ffd41a98914f39f072103f587bc04d50edd8a4c1e99f9cdb503e0e55e354b97d7ed9f79017f0c42589d9453ae"}]' '{"tb1q9yw25trkqlzrrju38c6wy8rqr4qlnrf4j0h5xt":0.01}'

0200000001305de711d39242c6e26560400ad45c3c5a256aebe36af849f237d227772da6050000000000ffffffff0140420f0000000000160014291caa2c7607c431cb913e34e21c601d41f98d3500000000


# ... Now I can partially sign it using one private key:
bitcoin-cli -testnet signrawtransactionwithkey '0200000001305de711d39242c6e26560400ad45c3c5a256aebe36af849f237d227772da6050000000000ffffffff0140420f0000000000160014291caa2c7607c431cb913e34e21c601d41f98d3500000000' '["cStuGJkCJkjUX4naKB5E8MWJNFVgCLLXDFuns7rbCN16KrY9iNdE"]' '[{"txid":"05a62d7727d237f249f86ae3eb6a255a3c5cd40a406065e2c64292d311e75d30","vout":0,"scriptPubKey":"a91490f224460e4fd1015baf429c229d6bb5e464413587","redeemScript":"522102e8c3591920ea995332889ff3b66df83b5a26fb9cd6ab10d78e54909e2892ff342102c522ba9d5063c526c46c5750f22c96d0593c40537e19dc3ffd41a98914f39f072103f587bc04d50edd8a4c1e99f9cdb503e0e55e354b97d7ed9f79017f0c42589d9453ae"}]'
{
  "hex": "0200000001305de711d39242c6e26560400ad45c3c5a256aebe36af849f237d227772da60500000000b50047304402200cdd01ea4db19c578c0fb09b517bc72cd215dd87f5cd0c6e4295136285b6b72502206c790ef84d16a1835cc4c506e854b620635f4f25cf2c43f6000da5b2107aa4cf01004c69522102e8c3591920ea995332889ff3b66df83b5a26fb9cd6ab10d78e54909e2892ff342102c522ba9d5063c526c46c5750f22c96d0593c40537e19dc3ffd41a98914f39f072103f587bc04d50edd8a4c1e99f9cdb503e0e55e354b97d7ed9f79017f0c42589d9453aeffffffff0140420f0000000000160014291caa2c7607c431cb913e34e21c601d41f98d3500000000",
  "complete": false,
  ... etc, display an error, normal because we must sign with 2 keys
}

# ... and then take the "hex" from that and complete the 2-of-3 signatures using one of the other private keys (note the "hex" result getting longer):
bitcoin-cli -testnet signrawtransactionwithkey '0200000001305de711d39242c6e26560400ad45c3c5a256aebe36af849f237d227772da60500000000b50047304402200cdd01ea4db19c578c0fb09b517bc72cd215dd87f5cd0c6e4295136285b6b72502206c790ef84d16a1835cc4c506e854b620635f4f25cf2c43f6000da5b2107aa4cf01004c69522102e8c3591920ea995332889ff3b66df83b5a26fb9cd6ab10d78e54909e2892ff342102c522ba9d5063c526c46c5750f22c96d0593c40537e19dc3ffd41a98914f39f072103f587bc04d50edd8a4c1e99f9cdb503e0e55e354b97d7ed9f79017f0c42589d9453aeffffffff0140420f0000000000160014291caa2c7607c431cb913e34e21c601d41f98d3500000000' '["cPVXpU3axwSWptbppzkVKL1Ep8jLqrcxSsiNnqyDfkwu9z9xUArK"]' '[{"txid":"05a62d7727d237f249f86ae3eb6a255a3c5cd40a406065e2c64292d311e75d30","vout":0,"scriptPubKey":"a91490f224460e4fd1015baf429c229d6bb5e464413587","redeemScript":"522103be9ab01b98f61bc85beaf6e442115c07136ddac6fb55778d62846758929e19142102c522ba9d5063c526c46c5750f22c96d0593c40537e19dc3ffd41a98914f39f072103f587bc04d50edd8a4c1e99f9cdb503e0e55e354b97d7ed9f79017f0c42589d9453ae"}]'
{
  "hex": "0200000001305de711d39242c6e26560400ad45c3c5a256aebe36af849f237d227772da60500000000fc004730440220114a5bfee1abed50d0085fd05530b45315257f0076f1ae54fc2b355988cfa52a022023887ff7cd17d273db5915aa44215db4a9c8062cb37aa413002b5c147970edd30147304402200cdd01ea4db19c578c0fb09b517bc72cd215dd87f5cd0c6e4295136285b6b72502206c790ef84d16a1835cc4c506e854b620635f4f25cf2c43f6000da5b2107aa4cf014c69522102e8c3591920ea995332889ff3b66df83b5a26fb9cd6ab10d78e54909e2892ff342102c522ba9d5063c526c46c5750f22c96d0593c40537e19dc3ffd41a98914f39f072103f587bc04d50edd8a4c1e99f9cdb503e0e55e354b97d7ed9f79017f0c42589d9453aeffffffff0140420f0000000000160014291caa2c7607c431cb913e34e21c601d41f98d3500000000",
  "complete": true
}

# And I can send the spending transactions:

bitcoin-cli -testnet sendrawtransaction 020000000118d256339e320ef6c97fcc26c991857e12b1dceecebae53e0a681daae9c5291400000000fc004730440220219574f9fc29735f0d00d89b5ca1ac5d2467243cc4f5b9bfaaad152f548e1fa902204abf62325616bedbeb7a9dd9d346f4e1d2f17a6c41d58ebb801d34681ba68cba01473044022011a8cbf7b3be462a708b2aba8683ec9e58a7fa11a180e948ccbf57e1c1c4b89b02203c8f6391d72b8000c0ea2135e982fe56ef8bb7d6b072654441804aea185b9964014c69522103be9ab01b98f61bc85beaf6e442115c07136ddac6fb55778d62846758929e19142102c522ba9d5063c526c46c5750f22c96d0593c40537e19dc3ffd41a98914f39f072103f587bc04d50edd8a4c1e99f9cdb503e0e55e354b97d7ed9f79017f0c42589d9453aeffffffff0140420f0000000000160014291caa2c7607c431cb913e34e21c601d41f98d3500000000

25cdf0f32318db8744e8796e85cb0641c68cfd3d28d7f75779616c6a0562ad3a

# You can see these transactions at:
# https://live.blockcypher.com/btc-testnet/tx/25cdf0f32318db8744e8796e85cb0641c68cfd3d28d7f75779616c6a0562ad3a/
